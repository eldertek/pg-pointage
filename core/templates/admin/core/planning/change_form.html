{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script>
    // Désactiver l'initialisation Select2 dans planning_admin.js
    window.DISABLE_PLANNING_ADMIN_SELECT2 = true;
    </script>
    <script src="{% static 'core/js/planning_admin.js' %}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
    // Résolution du conflit jQuery
    var select2jQuery = $.noConflict(true);
    
    // Utilisation de la fonction IIFE pour isoler notre code
    (function($) {
        $(document).ready(function() {
            console.log("Select2 initialisé avec jQuery version:", $.fn.jquery);
            
            // Fonction pour formater les options du site
            function formatSite(site) {
                if (site.loading) return site.text;
                return site.name || site.text;
            }

            // Fonction pour formater les options de l'utilisateur
            function formatUser(user) {
                if (user.loading) return user.text;
                if (!user.username) return user.text;
                return user.username + (user.full_name ? ' (' + user.full_name + ')' : '');
            }

            // Fonction de gestion des erreurs AJAX
            function handleAjaxError(error, retryFn, maxRetries = 3, currentRetry = 0) {
                console.error('Erreur AJAX:', error);
                
                if (currentRetry < maxRetries) {
                    // Attendre avant de réessayer (temps d'attente exponentiel)
                    const waitTime = Math.pow(2, currentRetry) * 1000;
                    
                    setTimeout(() => {
                        retryFn(currentRetry + 1);
                    }, waitTime);
                    
                    return true;
                }
                
                // Afficher un message d'erreur à l'utilisateur
                const errorMessage = $('<div>')
                    .addClass('select2-error-message')
                    .text('Une erreur est survenue lors de la récupération des données. Veuillez réessayer plus tard.');
                
                $('.select2-container').after(errorMessage);
                setTimeout(() => errorMessage.fadeOut(500, function() { $(this).remove(); }), 5000);
                
                return false;
            }

            // Configuration Select2 pour le site
            $('#id_site').select2({
                width: '100%',
                minimumInputLength: 1,
                ajax: {
                    url: '/api/autocomplete/site/',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term,
                            page: params.page || 1
                        };
                    },
                    processResults: function(data) {
                        console.log("Données reçues (site):", data);
                        return {
                            results: data
                        };
                    },
                    cache: true,
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("Erreur lors de l'autocomplete site:", textStatus, errorThrown, jqXHR.responseText);
                    }
                },
                templateResult: formatSite,
                templateSelection: formatSite,
                language: {
                    noResults: function() {
                        return "Aucun site trouvé";
                    },
                    searching: function() {
                        return "Recherche en cours...";
                    },
                    inputTooShort: function() {
                        return "Veuillez saisir au moins 1 caractère";
                    },
                    errorLoading: function() {
                        return "Impossible de charger les résultats";
                    }
                }
            });

            // Configuration Select2 pour l'utilisateur
            $('#id_user').select2({
                width: '100%',
                minimumInputLength: 1,
                ajax: {
                    url: '/api/autocomplete/user/',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term,
                            page: params.page || 1
                        };
                    },
                    processResults: function(data) {
                        console.log("Données reçues (user):", data);
                        return {
                            results: data
                        };
                    },
                    cache: true,
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("Erreur lors de l'autocomplete user:", textStatus, errorThrown, jqXHR.responseText);
                    }
                },
                templateResult: formatUser,
                templateSelection: formatUser,
                language: {
                    noResults: function() {
                        return "Aucun utilisateur trouvé";
                    },
                    searching: function() {
                        return "Recherche en cours...";
                    },
                    inputTooShort: function() {
                        return "Veuillez saisir au moins 1 caractère";
                    },
                    errorLoading: function() {
                        return "Impossible de charger les résultats";
                    }
                }
            });

            // Gestion de l'affichage des sections selon le type
            function updateFieldsVisibility() {
                var selectedType = $('#id_type').val();

                // Sélectionner les fieldsets par leur titre
                var $fixeFieldset = $('fieldset:contains("Paramètres horaires fixes")');
                var $frequenceFieldset = $('fieldset:contains("Paramètres de fréquence")');

                // Masquer les deux fieldsets
                $fixeFieldset.hide();
                $frequenceFieldset.hide();

                // Afficher le fieldset approprié selon le type
                if (selectedType === 'FIXE') {
                    $fixeFieldset.show();
                } else if (selectedType === 'FREQUENCE') {
                    $frequenceFieldset.show();
                }
            }

            // Initialisation et événements
            $('#id_type').on('change', updateFieldsVisibility);
            
            // Exécuter après un court délai pour s'assurer que la page est chargée
            setTimeout(function() {
                updateFieldsVisibility();
                
                // Suppression des widgets "now"
                $('.datetimeshortcuts').remove();
                $('.timezonewarning').remove();

                // Organisation des jours en ligne
                var $daysFieldset = $('.days-fieldset .form-row');
                if ($daysFieldset.length && !$daysFieldset.hasClass('days-container')) {
                    $daysFieldset.addClass('days-container');
                    $daysFieldset.find('.field-box').css({
                        'display': 'inline-block',
                        'margin-right': '15px'
                    });
                }
            }, 500);
        });
    })(select2jQuery);
    </script>
{% endblock %}

{% block content %}
    <div class="planning-form-container">
        {{ block.super }}
    </div>
{% endblock %} 